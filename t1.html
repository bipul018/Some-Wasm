<!doctype html>
<html>
  <head><title> Webasm test 1 </title> </head>
  <body>
    <canvas id="canvas" width="1100" height="850">

    </canvas>
    
    <script >
      //let instance= undefined;
      let g_instance;
      let canv_mem_ptr;
      let canv_mem_size;
      async function init() {

	  const {instance } = await WebAssembly.instantiateStreaming(
	      fetch("t1.wasm"),
	      {
		  "env": {
		      logit: function() {console.log(' from logit');},
		      grow_memory_by_page:  function(count){console.log(' Request to grow memory by ' + count + ' pages');instance.exports.memory.grow(count)}
		  }
	      }
	  );
	  g_instance = instance;
	  console.log('Memory buffer length : '+ g_instance.exports.memory.buffer.byteLength);
	  const jsArray = [1, 2, 3, 4, 5];
	  // Allocate memory for 5 32-bit integers
	  // and return get starting address.
	  const cArrayPointer = instance.exports.alloc_mem(jsArray.length * 4);
	  // Turn that sequence of 32-bit integers
	  // into a Uint32Array, starting at that address.
	  const cArray = new Uint32Array(
	      instance.exports.memory.buffer,
	      cArrayPointer,
	      jsArray.length
	  );
	  
	  // Copy the values from JS to C.
	  cArray.set(jsArray);
	  // Run the function, passing the starting address and length.
	  console.log(instance.exports.sum(cArrayPointer, cArray.length));
	  console.log('Memory buffer length : '+ g_instance.exports.memory.buffer.byteLength);
	  const canvas = document.getElementById("canvas");
	  const ctx = canvas.getContext("2d");

	  ctx.width = canvas.clientWidth;
	  ctx.height = canvas.clientHeight;
	  console.log('Canvas width : ' + ctx.width + ' Canvas height ' + ctx.height);
	  canv_mem_size = ctx.width * ctx.height * 4;
	  canv_mem_ptr = instance.exports.alloc_mem(canv_mem_size);
	  console.log('Canvas memory size : ' + canv_mem_size);
	  console.log('Memory buffer length : '+ g_instance.exports.memory.buffer.byteLength);
	  console.log('Last inx : ' + (canv_mem_ptr + canv_mem_size -1 ));
	  var ptr=g_instance.exports.alloc_mem(4 * 10);
	  console.log('The index of another alloced resource ' + ptr);
	  g_instance.exports.free_mem(ptr);
	  const ptr2=g_instance.exports.alloc_mem(156);
	  console.log('The index of another alloced resource ' + ptr2);
	  ptr = ptr2;
	  const args = new Uint32Array(
	      g_instance.exports.memory.buffer,
	      ptr,
	      10);
	  args[0] = 2;
	  args[1] = 9;
	  
	  console.log('HAHAHA : ' + g_instance.exports.nothing(8, ptr));
	  console.log('HEHE : ' + g_instance.exports.thing(8,1,2));

	  
	  
      }
      init().then(()=>{
	  setInterval(update, 80);
      });
      
      function update(){
	  const canvas = document.getElementById("canvas");
	  const ctx = canvas.getContext("2d");

	  
	  g_instance.exports.update_canvas(ctx.width, ctx.height, canv_mem_ptr);
	  //g_instance.exports.update_canvas(ctx.width, ctx.height);
	  const view = new Uint8ClampedArray(
	      g_instance.exports.memory.buffer,
	      canv_mem_ptr,
	      canv_mem_size);
	  
	  img = new ImageData(view,ctx.width, ctx.height);
	  ctx.putImageData(img, 0, 0);
	  
      }


    </script>
  </body>
</html>
