<!doctype html>
<html>
  <head><title> Webasm test 1 </title> </head>
  <body>
    <canvas id="canvas" width="1100" height="850">

    </canvas>
    
    <script >
      //let instance= undefined;
      let g_instance;
      let wins;
      let canv_mem_ptr;
      let canv_mem_size;
      var allocated_c_strs =[];
      function make_c_str(str){
	  if (typeof str === 'string') {
	      const cstr = wins.alloc_mem(str.length + 1);
	      if(cstr == 0)
		  return 0;
	      const view = new Uint8Array(
		  wins.memory.buffer,
		  cstr,
		  str.length + 1
	      );
	      for(var i = 0; i < str.length; i++){
		  view[i] = str.charCodeAt(i);
	      }
	      view[str.length] = 0;
	      allocated_c_strs.push(cstr);
	      return cstr;
	  }
	  else{
	      return 0;
	  }
      }
      function free_all_c_str(){
	  allocated_c_strs.forEach((item) =>
	      wins.free_mem(item));
	  allocated_c_strs = [];
      }
      function log_c_str(c_str){
	  const view = new Uint8Array(
	      g_instance.exports.memory.buffer,
	      c_str);

	  res_str = '';
	  var inx = 0;
	  while(view[inx] != 0){
	      res_str += String.fromCharCode(view[inx]);
	      inx++;
	  }
	  console.log(res_str);
      }
      async function init() {

	  const {instance } = await WebAssembly.instantiateStreaming(
	      fetch("t1.wasm"),
	      {
		  "env": {
		      logint: function(intval) {console.log('intval');},
		      grow_memory_by_page:  function(count){console.log(' Request to grow memory by ' + count + ' pages');instance.exports.memory.grow(count)},
		      log_c_str: log_c_str
		  }
	      }
	  );
	  g_instance = instance;
	  wins = g_instance.exports;
	  const canvas = document.getElementById("canvas");
	  const ctx = canvas.getContext("2d");

	  ctx.width = canvas.clientWidth;
	  ctx.height = canvas.clientHeight;
	  console.log('Canvas width : ' + ctx.width + ' Canvas height ' + ctx.height);
	  canv_mem_size = ctx.width * ctx.height * 4;
	  canv_mem_ptr = instance.exports.alloc_mem(canv_mem_size);
	  console.log('Canvas memory size : ' + canv_mem_size);
	  
	  
      }
      init().then(()=>{
	  setInterval(update, 80);
      });
      
      function update(){
	  const canvas = document.getElementById("canvas");
	  const ctx = canvas.getContext("2d");

	  
	  g_instance.exports.update_canvas(ctx.width, ctx.height, canv_mem_ptr);
	  //g_instance.exports.update_canvas(ctx.width, ctx.height);
	  const view = new Uint8ClampedArray(
	      g_instance.exports.memory.buffer,
	      canv_mem_ptr,
	      canv_mem_size);
	  
	  img = new ImageData(view,ctx.width, ctx.height);
	  ctx.putImageData(img, 0, 0);
	  
      }


    </script>
  </body>
</html>
